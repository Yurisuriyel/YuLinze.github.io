---
title: "绘图"
author: "Linze Yu"
date: "`r Sys.Date()`"
output:
  rmdformats::downcute:
    self_contained: TRUE
    default_style: "light"
    downcute_theme: "default"
    fig_width: 7
    fig_height: 5
    use_bookdown: TRUE
    gallery: TRUE
    lightbox: TRUE
    highlight: tango
editor_options: 
  markdown: 
    wrap: 72
---

```{r, 代码全局设置, echo = F}
knitr::opts_chunk$set(warning = F, error = F, message = F, prompt = T, comment = "", echo = T, dpi = 200, collapse = T, fig.align = "left", dev = "png", cache = T)
# , eval = F代码显示不运行
# , include = F代码运行, 不显示代码和结果
# , echo = T 显示代码块
# , prompt = T使用>开始代码
# , comment = ""结果不使用##
# , collapse = T#代码合并结果
# , out.width/out.height = 0.8缩放
# , fig.align = "left","center","right"对齐方式
# , dev = "pdf","png","svg","jpeg"记录设备
# , cache = T
```

<font size = 6>数据导入 > 数据清洗 > 数据变换 > **数据可视化** > 数据建模 > 可重现与交互报告</font>

## 加载包
```{r 加载包}
library("YuriR") #
library("tayloRswift") #
# library("rio") #
# library("tidyverse") #
# library("tidyfst") #
```

```{r}
import("D:/desktop/book/tidybook/data/case_MS/p131_4.xlsx") -> q
```

|图层|ggplot2结构|
|-:|:-|
|框架|`ggplot(data =, aes(x =, y =, color =, fill =, ...))+`| 
|美学外绘图图层(geom/stat)|`geom_XXX/stat_XXX(aes(x =, y = ), size =, color =, fill =, stroke =, alpha =, ...)+`|
|美学内图层(geom/stat)|`geom_XXX/stat_XXX(aes(x =, y =, size =, color =, fill =, ...), stroke =, alpha =, ...)+`|
|其他包图层|`::`|
|离散颜色变量图层|`scale_color_manual(values = cols)+`|
|离散填充变量图层|`scale_fill_manual(values = fills)+`|
|轴范围|`expand_limits(x = c(, ), y = c(, ), fill = seq(, , by = ))`|
|刻线|`scale_x/y_continuous(breaks = seq(, , by = ), minor_breaks = seq(, , by = ))+`|
|大小|`scale_size_continuous(seq(, , by = ),range = c(, ))`|
|颜色范围|`scale_fill_gradient(low = "", high = "")`|
|文字图层|`labs(x = "", y = "", title = "", subtitle = "", caption = "", tag = "")+`|
|总主题图层|`theme+`|
|个性化主题图层|`theme()`|

# 基础绘图
, fig.width = 5, fig.height = 7

## 空白 `geom_blank()`
```{r, fig.width = 5, fig.height = 7}
p空白 <- ggplot(data = q, aes(x = pH, y = CO2), ) +
  geom_blank(stat = "identity") +
  coord_flip() +
  labs(x = "X轴", y = "Y轴", title = "标题", subtitle = "副标题", caption = "说明文字", tag = "标签")
p空白
```

## QQ图`stat_qq()`+`stat_qq_line()`
```{r}
shapiro.test(q$CO2)
pQQ图 <- ggplot(data = q, aes(sample = CO2), ) +
  stat_qq_line(geom = "line") +
  stat_qq(geom = "point") +
  geom_abline(intercept = 0, slope = 1, color = "blue", size = 1) +
  expand_limits(x = c(-3, 3), y = c(0, 110)) +
  coord_fixed(ratio = 1 / 25)
pQQ图
```

## 直方图+密度曲线
### count`geom_histogram()`/`geom_density()`
```{r}
q %>%
  ggplot(., aes(x = CO2), ) +
  geom_histogram(aes(y = ..count..), bins = 50, stat = "bin") +
  stat_density(aes(y = ..count..), geom = "density")
```

### density`stat_bin()`/`stat_density()`
```{r}
q %>%
  ggplot(., aes(x = CO2), ) +
  stat_bin(aes(y = ..density..), bins = 10, geom = "col") +
  stat_density(aes(y = ..density..), geom = "density")
```

## 散点图`geom_point()`/`stat_identity(geom = "point")`
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2)) +
  geom_point(stat = "identity") -> p散点图
p散点图
```

## 顺序连接图`geom_path()`/`stat_identity(geom = "path")`
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2)) +
  geom_path(stat = "identity")
```

## 折线图`geom_line()`/`stat_identity(geom = "line")`;地毯线`geom_rug()`/`stat_identity(geom = "rug")`
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2)) +
  geom_line(stat = "identity") +
  geom_rug(stat = "identity")
```

## 二维直方图`geom_bin2d()`/`stat_bin_2d(geom = "tile")`;二维等高线图`geom_density_2d()`/`stat_density_2d(geom = "density_2d")`
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2)) +
  geom_bin2d(stat = "bin2d") +
  geom_density_2d(stat = "density_2d")
```

## 条图`geom_col/bar()`/`stat_summary(geom = "col/bar")`
```{r}
q %>%
  ggplot(., aes(x = group1, y = CO2)) +
  stat_summary(geom = "col", width = 0.3, color = "blue", fill = "red", alpha = 0.2) +
  geom_bar(stat = "summary", width = 0.5, color = "green", fill = "yellow", alpha = 0.2)
```

## errorbar`geom_errorbar()`
```{r}
q %>%
  ggplot(., aes(x = group1, y = CO2)) +
  stat_boxplot(geom = "errorbar", color = "red", width = 0.5) +
  stat_summary(fun.data = "mean_sd", geom = "errorbar", color = "blue", width = 0.5)
```
SEM,均值的标准误
$$SEM = SD / sqrt( n )$$
```{r}
q %>%
  summarize_dt(n = .N, sd = sd(CO2), mean = mean(CO2), by = group1) %>%
  ggplot(., aes(x = group1, y = mean)) +
  geom_errorbar(aes(ymin = mean - sd / sqrt(n), ymax = mean + sd / sqrt(n)), color = "red", width = 0.5) +
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), color = "blue", width = 0.5)
```

## crossbar`stat_summary(geom = "crossbar")`
```{r}
q %>%
  ggplot(., aes(x = group1, y = CO2)) +
  stat_summary(fun = "mean", geom = "crossbar", lineend = "square")
```

## 分组点图
```{r}
q %>%
  ggplot(., aes(x = group1, y = CO2)) +
  geom_point(stat = "identity", color = "red") +
  geom_jitter(stat = "identity", width = 0.2, color = "blue")
```

## 箱线图`stat_boxplot(geom = "boxplot")`+`stat_boxplot(geom = "errorbar")`
```{r}
q %>%
  ggplot(., aes(x = group1, y = CO2)) +
  stat_boxplot(geom = "errorbar") +
  stat_boxplot(geom = "boxplot")
```

## 提琴图`stat_ydensity(geom = "violin")`
```{r}
q %>%
  ggplot(., aes(x = group1, y = CO2)) +
  stat_ydensity(geom = "violin", trim = F)
```

## 参考线`geom_vline(xintercept=)`+`geom_hline(yintercept=)`+`geom_abline(intercept=, slope=)`+`geom_segment(x = , y = , xend = , yend = )`
```{r}
p垂直线 <- p散点图 +
  geom_vline(xintercept = 60) + # 垂直线
  geom_hline(yintercept = 120) + # 水平线
  geom_abline(intercept = 0, slope = 2) + # 函数直线
  geom_segment(x = 40, y = 80, xend = 80, yend = 120) # 线段
p垂直线
```

## 曲线段`geom_curve(x = , y = , xend = , yend = ,curvature = )`
```{r}
p曲线段 <- p散点图 +
  geom_curve(x = 40, y = 80, xend = 80, yend = 120, curvature = -0.5) +
  geom_curve(x = 40, y = 80, xend = 80, yend = 120, curvature = 0) +
  geom_curve(x = 40, y = 80, xend = 80, yend = 120, curvature = 0.5)
p曲线段
```

## 综合练习
```{r}
p综合图1 <- ggplot(q, aes(x = CO2, y = O2)) +
  geom_point(stat = "identity") +
  geom_line(stat = "identity") +
  geom_rug(stat = "identity")
p综合图1
```

```{r}
p综合图2 <- ggplot(q, aes(x = group1, y = CO2)) +
  stat_ydensity(geom = "violin", trim = F) +
  stat_boxplot(geom = "errorbar", width = 0.15) +
  stat_boxplot(geom = "boxplot", width = 0.15) +
  geom_jitter(stat = "identity", width = 0.2)
p综合图2
```

# aes美学外参数
## QQ图qqline+qq
```{r}
q %>%
  ggplot(., aes(sample = CO2), ) +
  stat_qq_line(linetype = 1, color = "#FC766A", alpha = 1, size = 1, lineend = "square") +
  stat_qq(shape = 21, color = "#FC766A", fill = "#95AAD3", alpha = 1, size = 3, stroke = 1)
```

## 直方图histogram
```{r}
q %>%
  ggplot(., aes(x = CO2), ) +
  geom_histogram(bins = 30, color = "#FC766A", fill = "#95AAD3", alpha = 0.5, size = 0.5, lineend = "square")
```

## 密度曲线density
```{r}
q %>%
  ggplot(., aes(x = CO2), ) +
  geom_density(color = "#FC766A", fill = "#95AAD3", alpha = 0.2, size = 1, linetype = 3, lineend = "square")
```

## 散点图point
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2)) +
  geom_point(shape = 21, color = "#FC766A", fill = "#95AAD3", alpha = 0.5, size = 3, stroke = 1)
```

## 折线图line;地毯线rug
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2)) +
  geom_line(linetype = 2, color = "#FC766A", alpha = 0.5, size = 1, lineend = "square") +
  geom_rug(color = "#FC766A", alpha = 0.5, size = 1, lineend = "square")
```

## 条图(col/bar)+errorbar
```{r}
q %>%
  summarize_dt(n = .N, sd = sd(CO2), mean = mean(CO2), by = group1) %>%
  ggplot(., aes(x = group1, y = mean)) +
  geom_col(color = "#FC766A", fill = "#95AAD3", alpha = 0.5, width = 0.5, size = 1, lineend = "square") +
  geom_errorbar(aes(ymin = mean - sd / sqrt(n), ymax = mean + sd / sqrt(n)), color = 1, width = 0.25, size = 1, lineend = "square")
```

## 箱线图boxplot+errorbar
```{r}
q %>%
  ggplot(., aes(x = group1, y = CO2)) +
  stat_boxplot(geom = "errorbar", color = "#FC766A", fill = "#95AAD3", alpha = 1, size = 1, lineend = "square", width = 0.5) +
  stat_boxplot(geom = "boxplot", color = NA, fill = "#FFFFFF", alpha = 1, size = 1, outlier.shape = 21, outlier.size = 3, outlier.alpha = 1, outlier.color = "#BD3645", outlier.fill = NA, outlier.stroke = 1, na.rm = T, lineend = "square", width = 0.5) +
  stat_summary(fun = "median", geom = "crossbar", width = 0.5, color = "#FC766A", lineend = "square")
```

## 提琴图violin
```{r}
q %>%
  ggplot(., aes(x = group1, y = CO2)) +
  stat_ydensity(geom = "violin", trim = F, color = "#FC766A", fill = "#95AAD3", alpha = 0.5, size = 1, draw_quantiles = c(0.25, 0.5, 0.75), lineend = "square")
```

# aes美学内参数
## 数据重塑
```{r}
longer_dt(q, age, pH, group1, name = "group", value = "value") -> q整理
slice_dt(q整理, 1:3)
```

## 箱线图aes
```{r}
q整理 %>%
  ggplot(., aes(x = group, y = value, color = group1, fill = group1)) +
  stat_boxplot(geom = "boxplot", alpha = 0.5, size = 1, outlier.shape = 21, outlier.size = 3, outlier.alpha = 1, outlier.color = "#BD3645", outlier.fill = NA, outlier.stroke = 1, na.rm = T, lineend = "square") +
  stat_boxplot(geom = "errorbar", alpha = 1, size = 1, lineend = "square") +
  theme(legend.position = "none")
```

## column-group
### `position_stack()`
```{r}
q整理 %>%
  ggplot(., aes(x = group, y = value, color = group1, fill = group1)) +
  stat_summary(geom = "col", alpha = 0.5, size = 1, position = position_stack(), lineend = "square") +
  theme(legend.position = "none")
```

### `position_fill()`
```{r}
q整理 %>%
  ggplot(., aes(x = group, y = value, color = group1, fill = group1)) +
  stat_summary(geom = "col", alpha = 0.5, size = 1, position = position_fill(), lineend = "square") +
  scale_y_continuous(labels = scales::percent) +
  theme(legend.position = "none")
```

### `position_dodge()`
```{r}
q整理 %>%
  ggplot(., aes(x = group, y = value, color = group1, fill = group1)) +
  stat_summary(geom = "col", alpha = 0.5, size = 1, position = position_dodge(width = 1), lineend = "square") +
  theme(legend.position = "none")
```

### `position_dodge2()`
```{r}
q整理 %>%
  ggplot(., aes(x = group, y = value, color = group1, fill = group1)) +
  stat_summary(geom = "col", alpha = 0.5, size = 1, position = position_dodge2(width = 2, padding = 0), lineend = "square") +
  theme(legend.position = "none")
```

## 分面
### `facet_wrap()`
```{r}
q整理 %>%
  ggplot(., aes(x = group, y = value, color = group1, fill = group1)) +
  stat_boxplot(geom = "boxplot", alpha = 0.5, size = 1, outlier.shape = 21, outlier.size = 3, outlier.alpha = 1, outlier.color = "#BD3645", outlier.fill = NA, outlier.stroke = 1, na.rm = T, lineend = "square") +
  stat_boxplot(geom = "errorbar", alpha = 1, size = 1, lineend = "square") +
  facet_wrap(group ~ group1, scales = "free", ncol = 2) +
  theme(legend.position = "none")
```

### `facet_grid()`
```{r}
q整理 %>%
  ggplot(., aes(x = group, y = value, color = group1, fill = group1)) +
  stat_boxplot(geom = "boxplot", alpha = 0.5, size = 1, outlier.shape = 21, outlier.size = 3, outlier.alpha = 1, outlier.color = "#BD3645", outlier.fill = NA, outlier.stroke = 1, na.rm = T, lineend = "square") +
  stat_boxplot(geom = "errorbar", alpha = 1, size = 1, lineend = "square") +
  facet_grid(group ~ group1, scales = "free") +
  theme(legend.position = "none")
```

## 散点图-气泡图(size)aes
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2, size = age)) +
  geom_point(stat = "identity", shape = 21, alpha = 1, stroke = 1, fill = NA)
```

## 散点图-连续颜色(color/fill)aes
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2, color = pH, fill = pH)) +
  geom_point(stat = "identity", shape = 21, alpha = 1, stroke = 1, size = 3)
```

## 散点图-形状(shape)aes
## 散点图-透明度(alpha)aes
## 折线图-线型(linetype)aes
## 综合练习
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2, size = age, color = group1, fill = pH)) +
  geom_point(stat = "identity", shape = 21, stroke = 1, alpha = 0.8)
```

# 度量
```{r}
dt <- import("D:/desktop/book/tidybook/data/test.xlsx")
dt %>%
  ggplot(., aes(x = group, y = value, color = group, fill = group)) +
  geom_col()

dt %>%
  ggplot(., aes(x = group, y = value, color = group, fill = group)) +
  geom_col() +
  scale_color_manual(values = cols) +
  scale_fill_manual(values = fills)

dt %>%
  ggplot(., aes(x = group, y = value, color = group, fill = group)) +
  geom_col() +
  scale_color_taylor(palette = "lover") +
  scale_fill_taylor(palette = "lover")
```

## 原点`expand_limits(x = c(, ), y = c(, ), fill = seq(, , by = ))`
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2, size = age, color = group1, fill = pH)) +
  geom_point(stat = "identity", shape = 21, stroke = 1, alpha = 0.8) +
  expand_limits(x = c(0, 200), y = c(0, 200), fill = seq(7, 7.5, by = 0.1))
```

## 调整Y轴`scale_y_continuous(breaks = seq(, , by = ), minor_breaks = seq(, , by = ))`
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2, size = age, color = group1, fill = pH)) +
  geom_point(stat = "identity", shape = 21, stroke = 1, alpha = 0.8) +
  scale_y_continuous(breaks = seq(40, 200, by = 20), minor_breaks = seq(40, 200, by = 10))
```

## 调整X轴`scale_x_continuous(breaks = seq(, , by = ), minor_breaks = seq(, , by = ))`
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2, size = age, color = group1, fill = pH)) +
  geom_point(stat = "identity", shape = 21, stroke = 1, alpha = 0.8) +
  scale_x_continuous(breaks = seq(0, 200, by = 10), minor_breaks = seq(0, 200, by = 5))
```

## 调整大小`scale_size_continuous(seq(, , by = ),range = c(, ))`
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2, size = age, color = group1, fill = pH)) +
  geom_point(stat = "identity", shape = 21, stroke = 1, alpha = 0.8) +
  scale_size_continuous(seq(65, 85, by = 5), range = c(2, 10))
```

## 调整颜色
### `scale_fill_gradient(low = "", high = "")`
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2, size = age, color = group1, fill = pH)) +
  geom_point(stat = "identity", shape = 21, stroke = 1, alpha = 0.8) +
  scale_fill_gradient(low = "#AAC8FC", high = "#FFB3B5") +
  expand_limits(fill = seq(7.2, 7.5, by = 0.1))
```

### `scale_fill_gradient2(low = "", mid = "", high = "", midpoint = )`
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2, size = age, color = group1, fill = pH)) +
  geom_point(stat = "identity", shape = 21, stroke = 1, alpha = 0.8) +
  scale_fill_gradient2(low = "#41B47A", mid = "#EDEF5C", high = "#E24C80", midpoint = 7.35) +
  expand_limits(fill = seq(7.2, 7.5, by = 0.1))
```

### `scale_fill_gradientn(colors = c())`
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2, size = age, color = group1, fill = pH)) +
  geom_point(stat = "identity", shape = 21, stroke = 1, alpha = 0.8) +
  scale_fill_gradientn(colors = c("#440154", "#470E61", "#481B6D", "#482576", "#46307E", "#443B84", "#404688", "#3C508B", "#38598C", "#33628D", "#2F6B8E", "#2C738E", "#287C8E", "#25838E", "#228C8D", "#1F948C", "#1E9D89", "#20A486", "#26AD81", "#31B57B", "#3FBC73", "#4FC46A", "#61CB5F", "#75D054", "#8BD646", "#A2DA37", "#B9DE28", "#D1E11C", "#E8E419", "#FDE725")) +
  expand_limits(fill = seq(7.2, 7.5, by = 0.1))
```

## 综合练习
```{r}
p综合图 <- ggplot(q, aes(x = CO2, y = O2, size = age, color = group1, fill = pH)) +
  geom_point(stat = "identity", shape = 21, stroke = 1, alpha = 0.8) +
  scale_x_continuous(breaks = seq(0, 200, by = 10), minor_breaks = seq(0, 200, by = 5)) +
  scale_y_continuous(breaks = seq(40, 200, by = 20), minor_breaks = seq(40, 200, by = 10)) +
  scale_size_continuous(seq(65, 85, by = 5), range = c(2, 5)) +
  scale_color_manual(values = cols) +
  scale_fill_gradientn(colors = c("#440154", "#470E61", "#481B6D", "#482576", "#46307E", "#443B84", "#404688", "#3C508B", "#38598C", "#33628D", "#2F6B8E", "#2C738E", "#287C8E", "#25838E", "#228C8D", "#1F948C", "#1E9D89", "#20A486", "#26AD81", "#31B57B", "#3FBC73", "#4FC46A", "#61CB5F", "#75D054", "#8BD646", "#A2DA37", "#B9DE28", "#D1E11C", "#E8E419", "#FDE725")) +
  expand_limits(fill = seq(7.2, 7.5, by = 0.1))
p综合图
```

# 棒棒糖图
```{r}
import("D:/desktop/book/tidybook/data/2020年全球癌症诊断数目最多的十个癌症.xlsx") %>%
  ggplot(., aes(x = group, y = value, color = group, fill = group)) +
  geom_segment(aes(x = reorder(group, value), xend = reorder(group, value), y = 0, yend = value), size = 2, alpha = 0.5, lineend = "square") +
  geom_point(aes(size = value), shape = 21, stroke = 1) +
  scale_color_manual(values = cols) +
  scale_fill_manual(values = fills) +
  coord_flip() +
  Yuri_theme +
  theme(legend.position = "none")
```

# 配对图
```{r}
data <- import("D:/desktop/book/tidybook/data/pvalue.xlsx")
data <- data.table(data)
data整理 <- longer_dt(data, n, group1, group2, group3, name = "group", value = "value")
data整理
data整理1 <- longer_dt(data整理, group, value, n, name = "group123", value = "value123")
data整理1
data整理1 %>%
  ggplot(., aes(x = group, y = value, color = group)) +
  stat_boxplot(geom = "errorbar", alpha = 1, width = 0.5, lineend = "square") +
  stat_boxplot(geom = "boxplot", alpha = 1, outlier.shape = 21, outlier.alpha = 1, outlier.color = "#BD3645", outlier.fill = NA, na.rm = T, fill = "#FFFFFF", width = 0.5, lineend = "square") +
  geom_line(aes(group = n), alpha = 0.5, linetype = 1, color = "#96999C", lineend = "square") +
  geom_point(alpha = 0.5, shape = 21, fill = NA) +
  geom_signif(
    comparisons = list(c("before", "after")),
    map_signif_level = T,
    hjust = 0.5,
    vjust = 0.5,
    # size = 1,
    # textsize = 6,
    margin_top = 0,
    step_increase = 0.05,
    tip_length = 0.02,
    orientation = "x",
    # manual = T,
    y_position = 11.5,
    test = t.test, lineend = "square"
  ) +
  expand_limits(y = c(6, 12.5)) +
  scale_y_continuous(breaks = seq(0, 50, by = 1), minor_breaks = seq(0, 0, by = 0)) +
  scale_color_manual(values = cols) +
  scale_fill_manual(values = fills) +
  facet_grid(value123 ~ group123) +
  Yuri_theme +
  theme(legend.position = "none")
```

# 透明度
```{r}
data.table(CO2 = c(rep(70, times = 20)), O2 = c(rep(140, times = 20)), group1 = c(rep("C", times = 20))) -> qc
rbindlist(list(q, qc), fill = T) -> qdt
qdt %>%
  ggplot(., aes(x = CO2, y = O2, color = group1, fill = group1)) +
  geom_point(size = 5, shape = 21, alpha = 0.1, stroke = 1) +
  scale_color_manual(values = cols) +
  scale_fill_manual(values = fills) +
  Yuri_theme +
  theme(legend.position = (c(0.95, 0.95))) +
  coord_fixed(ratio = 20 / 40)
```

# 频率气泡图
```{r}
qdt %>%
  ggplot(., aes(x = CO2, y = O2, color = group1, fill = group1)) +
  geom_point(shape = 21, alpha = 0.5, stroke = 1, stat = "sum") +
  scale_color_manual(values = cols) +
  scale_fill_manual(values = fills) +
  Yuri_theme +
  theme(legend.position = (c(0.95, 0.95))) +
  coord_fixed(ratio = 20 / 40)
```