---
title: "绘图其他"
author: "Linze Yu"
date: "`r Sys.Date()`"
output:
  rmdformats::downcute:
    self_contained: TRUE
    default_style: "light"
    downcute_theme: "default"
    fig_width: 7
    fig_height: 5
    use_bookdown: TRUE
    gallery: TRUE
    lightbox: TRUE
    highlight: tango
editor_options: 
  markdown: 
    wrap: 72
---

```{r, 代码全局设置, echo = F}
knitr::opts_chunk$set(warning = F, error = F, message = F, prompt = F, comment = "", echo = T, dpi = 200, fig.align = "left", dev = "png", cache = T)
# , eval = F代码显示不运行
# , include = F代码运行, 不显示代码和结果
# , echo = T 显示代码块
# , prompt = T使用>开始代码
# , comment = ""结果不使用##
# , collapse = T#代码合并结果
# , out.width/out.height = 0.8缩放
# , fig.align = "left","center","right"对齐方式
# , dev = "pdf","png","svg","jpeg"记录设备
# , cache = T
```

<font size = 6>数据导入 > 数据清洗 > 数据变换 > **数据可视化** > 数据建模 > 可重现与交互报告</font>

## 加载包
```{r 加载包}
library("YuriR") #
library("ggbeeswarm") # 散点防止重合
library("ggside") # 边际直方图/密度曲线
library("hexbin") # 六边形
library("ggpointdensity") # 散点图和二维密度图之间的交叉
library("webr") # 饼图+甜甜圈图+旭日图+检验绘图
# library("ggwordcloud")#词云
# library("gghalves")#组合
```

```{r}
import("D:/desktop/book/tidybook/data/case_MS/p131_4.xlsx") -> q
```

# 美学举例(A药B药降血糖)
```{r}
data <- import("D:/desktop/book/tidybook/data/case_MS/P57_t.xlsx")
data %>%
  slice_dt(1:3)
```

## before
```{r}
data %>%
  ggplot(., aes(x = drug, y = before)) +
  stat_boxplot(geom = "errorbar", alpha = 1, size = 0.5, width = 0.5, lineend = "square") +
  stat_boxplot(geom = "boxplot", alpha = 1, size = 0.5, na.rm = T, fill = "#FFFFFF", width = 0.5, lineend = "square") +
  expand_limits(y = c(7, 12)) -> before
```

## after
```{r}
data %>%
  ggplot(., aes(x = drug, y = after)) +
  stat_boxplot(geom = "errorbar", alpha = 1, size = 0.5, width = 0.5, lineend = "square") +
  stat_boxplot(geom = "boxplot", alpha = 1, size = 0.5, na.rm = T, fill = "#FFFFFF", width = 0.5, lineend = "square") +
  expand_limits(y = c(7, 9)) -> after
```

## 如何比较患者使用降糖药前后的差异
```{r}
databa <- longer_dt(data, n, drug, name = "group", value = "value")
databa %>%
  slice_dt(1:3)
databa %>%
  ggplot(., aes(x = group, y = value)) +
  stat_boxplot(geom = "errorbar", alpha = 1, size = 0.5, width = 0.5, lineend = "square") +
  stat_boxplot(geom = "boxplot", alpha = 1, size = 0.5, na.rm = T, fill = "#FFFFFF", width = 0.5, lineend = "square") +
  geom_signif(
    comparisons = list(c("before", "after")),
    map_signif_level = T,
    size = 0.5,
    hjust = 0.5,
    vjust = 0.5,
    textsize = 6,
    margin_top = 0,
    step_increase = 0.05,
    tip_length = 0.02,
    orientation = "x",
    # manual = T,
    y_position = 11.5,
    test = t.test,
  ) +
  expand_limits(y = c(6, 12)) -> dif
```

## 综合
```{r}
databa %>%
  ggplot(., aes(x = group, y = value, color = drug)) +
  stat_boxplot(geom = "errorbar", alpha = 1, size = 0.5, width = 0.5, lineend = "square") +
  stat_boxplot(geom = "boxplot", alpha = 1, size = 0.5, na.rm = T, fill = "#FFFFFF", width = 0.5, lineend = "square") +
  geom_signif(
    comparisons = list(c("before", "after")),
    map_signif_level = T,
    size = 0.5,
    hjust = 0.5,
    vjust = 0.5,
    textsize = 6,
    margin_top = 0,
    step_increase = 0.05,
    tip_length = 0.02,
    orientation = "x",
    # manual = T,
    y_position = 11.5,
    test = t.test,
  ) +
  expand_limits(y = c(6, 12)) +
  theme(legend.position = (c(0.95, 0.25))) -> sum
```

```{r}
lay <- lay_new(
  matrix(1:4, nc = 2),
  widths = c(1, 1),
  heights = c(1, 1)
)
lay_grid(list(before, dif, after, sum), lay)
```

# ggplot2其他
## 折线直方图
```{r}
q %>%
  ggplot(., aes(x = CO2, color = group1, fill = group1)) +
  geom_freqpoly(size = 1, alpha = 1, stat = "bin") +
  scale_color_manual(values = cols) +
  scale_fill_manual(values = fills) +
  Yuri_theme +
  theme(legend.position = (c(0.95, 0.95))) +
  coord_fixed(ratio = 20 / 2)
```

## 点直方图
```{r}
q %>%
  ggplot(., aes(x = CO2, color = group1, fill = group1)) +
  geom_dotplot(size = 1, alpha = 0.5, shape = 21, stroke = 1) +
  scale_color_manual(values = cols) +
  scale_fill_manual(values = fills) +
  Yuri_theme +
  theme(legend.position = (c(0.95, 0.95)))
```

## 拟合分位数的回归线
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2, color = group1, fill = group1)) +
  geom_quantile(size = 1, linetype = 1, alpha = 1, stat = "quantile") +
  scale_color_manual(values = cols) +
  scale_fill_manual(values = fills) +
  Yuri_theme +
  theme(legend.position = (c(0.95, 0.95))) +
  coord_fixed(ratio = 20 / 20)
```

## 面积图
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2, color = group1, fill = group1)) +
  geom_area(size = 1, linetype = 1, alpha = 0.5, stat = "identity") +
  scale_color_manual(values = cols) +
  scale_fill_manual(values = fills) +
  Yuri_theme +
  theme(legend.position = (c(0.95, 0.95))) +
  coord_fixed(ratio = 20 / 50)
```

## 阶梯图
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2, color = group1, fill = group1)) +
  geom_step(size = 1, linetype = 1, alpha = 1, stat = "identity") +
  scale_color_manual(values = cols) +
  scale_fill_manual(values = fills) +
  Yuri_theme +
  theme(legend.position = (c(0.95, 0.95))) +
  coord_fixed(ratio = 20 / 40)
```

## 二维等高线颜色密度图
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2)) +
  Yuri_theme +
  geom_density_2d_filled(bins = 20, alpha = 1, show.legend = F) +
  coord_fixed(ratio = 20 / 40)
```

## 六边形二维直方图
(hexbin)
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2)) +
  Yuri_theme +
  geom_hex(bins = 20, alpha = 1, color = "#FFFFFF", size = 0.5) +
  theme(legend.position = (c(0.95, 0.95))) +
  coord_fixed(ratio = 20 / 40)
```

## 散点图和二维密度图之间的交叉
(ggpointdensity)
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2)) +
  Yuri_theme +
  geom_pointdensity(method = "auto", adjust = 4, alpha = 1, size = 5, shape = 16, stroke = 1) + # "default""kde2d"
  theme(legend.position = (c(0.95, 0.95))) +
  coord_fixed(ratio = 20 / 40)
```

# 社科相关
## (ggplot2)内置
```{r}
import("D:/desktop/book/tidybook/data/4.xlsx") %>%
  mutate_dt(n = 1) %>%
  ggplot(., aes(x = Q, y = n)) +
  geom_col(aes(fill = Q), color = 1, alpha = 0.5) +
  Yuri_theme +
  theme(legend.position = "none") -> stat
```

## (tidyfst)外部计算
```{r}
import("D:/desktop/book/tidybook/data/4.xlsx") %>%
  summarise_dt(n = .N, by = Q) %>%
  ggplot(., aes(x = Q, y = n)) +
  geom_col(aes(fill = Q), color = 1, alpha = 0.5) +
  Yuri_theme +
  theme(legend.position = "none") -> fst
```

# (customLayout)图片拼接
## 创建画布
```{r}
lay1 <- lay_new(
  matrix(1:4, nc = 2),
  widths = c(1, 2),
  heights = c(1, 2)
)
```

```{r}
lay2 <- lay_new(
  matrix(1:4, nc = 2),
  widths = c(1, 2),
  heights = c(1, 2)
)
```

## 画布列拼接
```{r}
col <- lay_bind_col(lay1, lay2, widths = c(1, 2))
lay_show(col)
```

## 画布行拼接
```{r}
row <- lay_bind_row(lay1, lay2, heights = c(1, 2))
lay_show(row)
```

## 内拼接画布
```{r}
inside <- lay_split_field(lay1, lay2, field = 4)
lay_show(inside)
```

## 拼接
```{r}
m <- lay_new(matrix(1:2, nc = 2))
lay_grid(list(stat, fst), m)
```

# (ggwordcloud)词云
```{r}
set.seed(2022)
import("D:/desktop/book/tidybook/data/2013-2020年中国总理记者会关键词词频.xlsx") %>%
  mutate_vars(value, scale) %>%
  ggplot(., aes(label = words, size = value, color = value)) +
  geom_text_wordcloud(family = "Source Han Sans") +
  scale_size_area(max_size = 15) +
  scale_color_gradient(low = "#F8CDCD", high = "#696AAD") +
  Yuri_theme +
  theme(legend.position = "none")
```

# 边际图
(ggside)
```{r}
q %>%
  ggplot(., aes(x = CO2, y = O2, color = group1, fill = group1)) +
  geom_point(size = 5, shape = 21, alpha = 0.7, stroke = 1) +
  scale_x_continuous(breaks = seq(0, 250, by = 20), minor_breaks = seq(0, 250, by = 10)) +
  scale_y_continuous(breaks = seq(0, 250, by = 20), minor_breaks = seq(0, 250, by = 10)) +
  geom_xsidehistogram(aes(y = after_stat(count)), bins = 20, alpha = 0.2) +
  geom_ysidehistogram(aes(x = after_stat(count)), bins = 20, alpha = 0.2) +
  scale_ysidex_continuous(breaks = seq(0, 50, by = 5), guide = guide_axis(angle = 0)) +
  scale_xsidey_continuous(breaks = seq(0, 50, by = 5), guide = guide_axis(angle = 0)) +
  scale_color_manual(values = cols) +
  scale_fill_manual(values = fills) +
  Yuri_theme +
  theme(
    ggside.panel.scale = 0.2,
    ggside.panel.border = element_rect(color = NA, fill = NA),
    ggside.panel.grid = element_line(color = 1, size = 1, linetype = "1"),
    ggside.panel.background = element_rect(color = NA, fill = NA)
  ) +
  theme(legend.position = "none") +
  coord_fixed(ratio = 20 / 40)
```

### 其他代码
- `geom_xsidefreqpoly(aes(y=after_stat(count)), binwidth = 1)+` 
- `geom_ysidefreqpoly(aes(x=after_stat(count)), binwidth = 1)+`

- `geom_xsidecol()+`
- `geom_ysidecol()+`
  
- `geom_xsideboxplot(aes(y = as.numeric(CO2)), orientation = "y", outlier.color = "#BD3645", outlier.fill = NA, outlier.shape = 21, outlier.size = 2, outlier.stroke = 0.5, outlier.alpha = 1)+`
- `geom_ysideboxplot(aes(x = as.numeric(O2)), orientation = "x", outlier.color = "#BD3645", outlier.fill = NA, outlier.shape = 21, outlier.size = 2, outlier.stroke = 0.5, outlier.alpha = 1)+`

- `geom_xsidedensity(aes(y = after_stat(density)), position = "stack")+`#count
- `geom_ysidedensity(aes(x = after_stat(density)), position = "stack")+`#count

- `geom_xsidehistogram(aes(y = after_stat(density)), bins = 30)+`#count
- `geom_ysidehistogram(aes(x = after_stat(density)), bins = 30)+`#count

- `geom_xsidepoint(aes(y = O2))+`
- `geom_ysidepoint(aes(x = CO2))+`

- `geom_xsideviolin(aes(y = as.numeric(CO2)), orientation = "y")+`
- `geom_ysideviolin(aes(x = as.numeric(O2)), orientation = "x")+`

# (ggbeeswarm)微笑散点图
```{r}
import("D:/desktop/book/tidybook/data/case_MS/P57_t.xlsx") %>%
  longer_dt(n, drug, name = "group", value = "value") %>%
  ggplot(., aes(x = group, y = value, color = drug, fill = drug)) +
  geom_beeswarm(cex = 4, priority = "density", size = 5, shape = 21, alpha = 0.5, stroke = 1, method = "swarm", corral = "gutter") +
  # priority = "descending""density""random""none"
  # method = "compactswarm""hex""square""center"
  # corral = "wrap""random""omit"
  # geom_quasirandom(method = "smiley",cex = 4, size = 5, shape = 21, alpha = 0.5, stroke = 1)+
  scale_color_manual(values = cols) +
  scale_fill_manual(values = fills) +
  Yuri_theme +
  theme(legend.position = (c(0.95, 0.95)))
```

# (gghalves)散点+箱线+提琴
```{r}
import("D:/desktop/book/tidybook/data/case_MS/P57_t.xlsx") %>%
  longer_dt(n, drug, name = "group", value = "value") %>%
  ggplot(., aes(x = group, y = value, color = group)) +
  geom_half_boxplot(alpha = 0.8, size = 1, position = position_nudge(x = 0, y = 0), side = "l", fill = NA, center = TRUE) +
  geom_half_violin(alpha = 0.8, size = 1, position = position_nudge(x = 0, y = 0), side = "r", fill = NA, trim = FALSE) +
  geom_half_point(shape = 21, stroke = 1, size = 2, side = "l", range_scale = 0.5) +
  scale_color_manual(values = cols) +
  scale_fill_manual(values = fills) +
  Yuri_theme +
  theme(legend.position = (c(0.95, 0.95)))
```

# (ggbreak)坐标轴截断
```{r}
import("D:/desktop/book/tidybook/data/break.xlsx") %>%
  longer_dt(n, name = "group", value = "value") %>%
  summarize_dt(n = .N, sd = sd(value), mean = mean(value), by = group) %>%
  ggplot(., aes(x = group, y = mean, color = group, fill = group)) +
  geom_col(alpha = 0.5, width = 0.5, size = 1, color = NA, lineend = "square") +
  geom_errorbar(aes(ymin = mean - sd / sqrt(n), ymax = mean + sd / sqrt(n)), width = 0.25, size = 1, lineend = "square") +
  scale_color_manual(values = cols) +
  scale_fill_manual(values = fills) +
  ggbreak::scale_y_break(c(10, 100), ticklabels = NULL, scales = 1) +
  Yuri_theme +
  theme(legend.position = "none")
```

# 生存曲线
`library("survminer")#`  
`library("survival")#`  
```{r}
import("D:/desktop/book/tidybook/data/基线资料表.xlsx") -> w
fit <- survfit(Surv(Time, Status) ~ Drug, data = w) # 创建生存对象, 数据集来源
fit
ggsurvplot(
  fit,
  data = w,
  fun  = "pct", # "cumhaz"绘制累计风险曲线, "pct"绘制生存概率"event"绘制累计事件
  palette = c("#95AAD3", "#FC766A"), # 自定义调色板
  linetype = 1,
  # conf.int = T,#增加置信区间
  pval = T, # 添加P值
  pval.method = F,
  test.for.trend = F,
  surv.median.line = "hv", # 增加中位生存时间
  risk.table  = F, # 添加风险表
  # cumevents = F,
  # cumcensor = F,
  tables.height = 0.3, # 主要生存图下所有表格的高度
  # add.all = T,#添加总患者生存曲线
  size = 1,
  legend = c(0.95, 0.95), # 指定图例位置
  legend.title = "", # 设置图例标题
  legend.labs = c("Drug A", "Drug B"), # 指定图例分组标签
  surv.plot.height = 0.7,
  # break.x.by = 5,#设置x轴刻度间距
  # break.y.by = 10,#设置x轴刻度间距
  surv.scale = "default", # "percent"
  # xlim = c(0, 25),
  # ylim = c(0, 100),
  axes.offset = T,
  # conf.int.fill = c("#95AAD3", "#FC766A"),
  conf.int.style = "ribbon", # "step"ribbon
  conf.int.alpha = 0.3,
  pval.size = 5,
  pval.coord = c(0.95, 0.95),
  censor = T,
  censor.size = 4.5,
  censor.shape = 3,
  tables.col = "strata",
  fontsize = 5,
  font.family = "Source Han Sans",
  tables.y.text = T,
  tables.y.text.col = T,
  risk.table.title = "",
  risk.table.pos = "out",
  ggtheme = Yuri_theme,
  tables.theme = Yuri_theme
) +
  labs(x = "Follow up time(d)", y = "survival probability", tag = "tag")
```

# Violin+SEM+line
```{r, echo = F}
import("D:/desktop/book/tidybook/data/case_2/4.xlsx") %>%
  longer_dt(., name = "group", value = "value") -> c
c[, c("mean", "sd", "n") := .(mean(value), sd(value), .N), by = group]
c %>%
  ggplot(., aes(x = group, y = mean)) +
  geom_violin(aes(x = group, y = value), color = NA, fill = "#696AAD", alpha = 0.3, width = 0.5) +
  geom_errorbar(aes(ymin = mean - sd / sqrt(n), ymax = mean + sd / sqrt(n)), color = "#696AAD", width = 0.2, size = 1) +
  geom_segment(x = 1, y = 0.434, xend = 2, yend = 0.785, color = "#696AAD", size = 1) +
  geom_segment(x = 2, y = 0.785, xend = 3, yend = 0.691, color = "#696AAD", size = 1) +
  geom_point(aes(x = group, y = mean), color = "#696AAD", shape = 21, size = 2, fill = NA, stroke = 1, ) +
  scale_y_continuous(breaks = seq(0, 2, by = 0.2), minor_breaks = seq(0, 0, by = 0)) +
  Yuri_theme
```

# (webr)饼图+甜甜圈图+旭日图
```{r}
import("D:/desktop/book/tidybook/data/2019年全球医生和护士中的男性占比.xlsx") -> data
```

```{r}
PieDonut(data, aes(pies = group, donuts = 男医生), labelposition = 1, title = "labelposition=1", explode = 1, selected = c(2, 3, 5), explodeDonut = T)
```

# ggforce

